
<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>रिकवरी डॅशबोर्ड</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #1E8449; /* Green for Offline */
            --online-color: #3498DB; /* Blue for Online */
            --highlight-color: #D35400;
            --danger-color: #C0392B;
            --bg-color: #f4f7fc;
            --card-bg-color: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --border-color: #e0e5ec;
            --shadow: 0 6px 20px rgba(0, 90, 156, 0.1);
            --border-radius: 12px;
        }
        body {
            font-family: 'Noto Sans Devanagari', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 1.5rem;
            color: var(--text-color);
        }
        .container { max-width: 1800px; margin: auto; }
        header { text-align: center; margin-bottom: 1.5rem; }
        header h1 { color: var(--heading-color); font-size: 2.4rem; font-weight: 700; }
        .controls { background: var(--card-bg-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .controls label { font-weight: 600; font-size: 1.1rem; color: var(--heading-color); }
        .controls input[type="date"] { padding: 0.7rem; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        .refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .refresh-btn:hover { background-color: #004a80; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .tab-link { padding: 0.8rem 1.5rem; cursor: pointer; font-weight: 600; font-size: 1.1rem; border: none; background-color: transparent; border-bottom: 4px solid transparent; transition: all 0.3s ease; color: var(--text-color); }
        .tab-link.active { color: var(--primary-color); border-bottom: 4px solid var(--primary-color); background-color: #eaf2f8; border-radius: 8px 8px 0 0; }
        .dashboard-content { display: flex; flex-direction: column; gap: 2rem; }
        .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .kpi-card { display: flex; align-items: center; gap: 1.5rem; background: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card.clickable { cursor: pointer; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 90, 156, 0.15); }
        .kpi-card .icon { font-size: 2.5rem; padding: 1rem; border-radius: 50%; display: grid; place-items: center; }
        .kpi-card .text h3 { margin: 0 0 0.4rem; font-size: 1rem; color: #555; font-weight: 500; }
        .kpi-card .text p { margin: 0; font-size: 2.1rem; font-weight: 700; color: var(--heading-color); }
        .insights-card { background: linear-gradient(135deg, #eaf2f8, #e4ecf7); border: 1px solid #aed6f1; padding: 1.5rem; border-radius: var(--border-radius); }
        .insights-card h2 { margin-top: 0; color: var(--primary-color); }
        .insights-card ul { padding-left: 20px; margin: 0; }
        .insights-card li { margin-bottom: 0.75rem; font-size: 1.1rem; line-height: 1.6; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem; }
        .chart-container, .table-wrapper { background: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .table-wrapper { overflow-x: auto; }
        .table-wrapper h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 0.9rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: linear-gradient(135deg, #f8f9fa, #eef2f7); font-weight: 600; color: var(--primary-color); font-size: 1rem; }
        tbody tr:hover { background-color: #f1f5f9; }
        tfoot tr { background-color: #eaf2f8; font-weight: bold; font-size: 1.1rem; }
        .highlight-row { background-color: #feefea !important; font-weight: 600; color: var(--danger-color); }
        .loader { text-align: center; font-size: 1.2rem; padding: 2rem; color: var(--primary-color); }

        #fullReportTable { font-size: 0.95rem; }
        #fullReportTable th, 
        #fullReportTable td { padding: 0.8rem 0.7rem; }
        
        .delete-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        .delete-btn:hover { background-color: #922b21; }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 700px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.4s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        .modal-body {
             max-height: 60vh;
             overflow-y: auto;
        }
        .modal-body table { font-size: 1rem; }

        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }

    </style>
</head>
<body>
<main class="container">
    <header><h1>रिकवरी संनियंत्रण डॅशबोर्ड</h1></header>
    <div class="controls">
        <label for="dateFilter">दिनांक निवडा:</label>
        <input type="date" id="dateFilter">
        <button class="refresh-btn" onclick="loadDashboardData()">डेटा रिफ्रेश करा</button>
    </div>
    <nav class="tabs" id="unitTabs"></nav>
    <div id="dashboard-content"></div>
</main>

<!-- The Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">तपशील</h2>
            <span class="close-button">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamic content will be injected here -->
        </div>
    </div>
</div>

<script>
    const SHEET_ID = "1FJQ7fd__PRnHTDjfvOPWSwGo2_w-S-4sx1mcpRTVskk";
    const API_KEY = "AIzaSyAQQZz2KDKZtJw7YZBRAvHaO-Uy68Ps57s";
    const STAFF_SHEET_NAME = "StaffList";
    const REPORTS_SHEET_NAME = "Recovery Data";
    
    // **येथे तुमची वेब ॲप URL पेस्ट करा**
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzsiLcDwscTAdmgKszLVjYfKOoj-GLisdLSIX-4kfvweB_JIwkkygVznGN6JEDgHPw/exec";

    google.charts.load('current', {'packages':['corechart']});

    let fullData = [];
    let staffList = [];
    let activeUnit = 'संपूर्ण';
    let currentFilteredData = {
        daily: [],
        highBalance: [],
        totalCash: []
    };
    
    const safeParseFloat = (str) => parseFloat(String(str).replace(/,/g, '')) || 0;

    const formatCurrency = (val) => new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(safeParseFloat(val));

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
        document.getElementById('dateFilter').addEventListener('change', () => renderDashboard(activeUnit));
        
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.querySelector('.close-button');
        closeBtn.onclick = () => modal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };
        
        google.charts.setOnLoadCallback(loadDashboardData);
    });

    async function loadDashboardData() {
        const contentArea = document.getElementById('dashboard-content');
        contentArea.innerHTML = '<div class="loader">डेटा लोड होत आहे, कृपया प्रतीक्षा करा...</div>';
        try {
            const reportsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/'${REPORTS_SHEET_NAME}'?key=${API_KEY}`;
            const staffUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${STAFF_SHEET_NAME}?key=${API_KEY}`;
            const [reportsResponse, staffResponse] = await Promise.all([fetch(reportsUrl), fetch(staffUrl)]);
            if (!reportsResponse.ok || !staffResponse.ok) throw new Error('API ला प्रतिसाद मिळाला नाही. कृपया की (Key) किंवा शीट आयडी तपासा.');
            const reportsRaw = await reportsResponse.json();
            const staffRaw = await staffResponse.json();
            const headers = reportsRaw.values[0];
            fullData = (reportsRaw.values.slice(1) || []).map(row => {
                let obj = {};
                headers.forEach((header, index) => obj[header.trim()] = row[index] || '');
                return obj;
            });
            staffList = (staffRaw.values.slice(1) || []).map(row => ({unit: row[0], name: row[1]}));
            initializeDashboard();
        } catch (error) {
            contentArea.innerHTML = `<div class="loader" style="color: var(--danger-color);">डेटा लोड करताना त्रुटी आली: ${error.message}</div>`;
        }
    }

    function initializeDashboard() {
        const units = ['संपूर्ण', ...new Set(staffList.map(s => s.unit).filter(Boolean))].sort((a, b) => a === 'संपूर्ण' ? -1 : b === 'संपूर्ण' ? 1 : a.localeCompare(b, 'mr'));
        const tabsContainer = document.getElementById('unitTabs');
        tabsContainer.innerHTML = '';
        units.forEach(unit => {
            const tab = document.createElement('button');
            tab.className = 'tab-link';
            tab.textContent = unit;
            if (unit === activeUnit) tab.classList.add('active');
            tab.onclick = () => {
                document.querySelector('.tab-link.active')?.classList.remove('active');
                tab.classList.add('active');
                activeUnit = unit;
                renderDashboard(activeUnit);
            };
            tabsContainer.appendChild(tab);
        });
        renderDashboard(activeUnit);
    }
    
    function calculateLatestEntriesAsOf(targetDate) {
        const latestEntries = {};
        const relevantData = fullData.filter(row => row['दिनांक'] && new Date(row['दिनांक']) <= new Date(targetDate));
        for (const row of relevantData) {
            const staffName = row['स्टाफचे नांव'];
            if (!staffName) continue;
            if (!latestEntries[staffName] || (new Date(row['दिनांक']).getTime() === new Date(latestEntries[staffName]['दिनांक']).getTime() && new Date(row['Timestamp']).getTime() > new Date(latestEntries[staffName]['Timestamp']).getTime()) || new Date(row['दिनांक']) > new Date(latestEntries[staffName]['दिनांक'])) {
                 latestEntries[staffName] = row;
            }
        }
        return Object.values(latestEntries);
    }

    function renderDashboard(unit) {
        const dateFilter = document.getElementById('dateFilter').value;
        let dailyData = fullData.filter(row => row['दिनांक'] === dateFilter);
        if (unit !== 'संपूर्ण') { dailyData = dailyData.filter(row => row['युनिट'] === unit); }
        
        const latestDataAsOfDate = calculateLatestEntriesAsOf(dateFilter);
        const highBalanceStaff = latestDataAsOfDate.filter(row => safeParseFloat(row['हातावर शिल्लक']) > 3000);
        const totalCashInHandStaff = latestDataAsOfDate.filter(row => safeParseFloat(row['हातावर शिल्लक']) > 0);
        
        currentFilteredData.daily = dailyData;
        currentFilteredData.highBalance = (unit === 'संपूर्ण') ? highBalanceStaff : highBalanceStaff.filter(s => s.युनिट === unit);
        currentFilteredData.totalCash = (unit === 'संपूर्ण') ? totalCashInHandStaff : totalCashInHandStaff.filter(s => s.युनिट === unit);

        const contentArea = document.getElementById('dashboard-content');
        contentArea.innerHTML = `
            <div class="kpi-cards" id="kpiCards"></div>
            <div class="dashboard-grid">
                <div class="chart-container"><div id="topCashInHandChart" style="height: 400px; width: 100%;"></div></div>
                <div class="chart-container"><div id="breakdownChart" style="height: 400px; width: 100%;"></div></div>
            </div>
            <div class="table-wrapper"><h2 style="color:var(--primary-color);">महत्वाचे: ३००० पेक्षा जास्त शिल्लक असलेले स्टाफ</h2><table id="highBalanceTable"></table></div>
            <div class="table-wrapper"><h2>संपूर्ण तपशीलवार रिपोर्ट (${new Date(dateFilter).toLocaleDateString('en-GB')})</h2><table id="fullReportTable"></table></div>
            <div class="insights-card" id="managerialInsights"></div>`;
        
        renderKpiCards(dailyData, highBalanceStaff, latestDataAsOfDate, unit);
        renderHighBalanceTable(unit, highBalanceStaff);
        renderDetailedReportTable(dailyData);
        drawCharts(dailyData, latestDataAsOfDate);
        renderManagerialInsights(dailyData, highBalanceStaff);
    }

    function renderKpiCards(dailyData, highBalanceStaff, latestData, unit) {
        const onlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['ऑनलाइन रिकवरी']), 0);
        const offlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['ऑफलाईन रिकवरी']), 0);
        const totalRecovery = onlineRecovery + offlineRecovery;
        const highBalanceCount = (unit === 'संपूर्ण' ? highBalanceStaff : highBalanceStaff.filter(s => s.युनिट === unit)).length;
        
        let totalCashInHand = (unit === 'संपूर्ण' ? latestData : latestData.filter(row => row['युनिट'] === unit))
                                .reduce((sum, row) => sum + safeParseFloat(row['हातावर शिल्लक']), 0);

        const phonePeQrTotal = dailyData.reduce((s, r) => s + safeParseFloat(r['फोनपे QR']), 0);
        const phonePeQrPercentage = totalRecovery > 0 ? (phonePeQrTotal / totalRecovery) * 100 : 0;
        const formattedPercentage = phonePeQrPercentage.toFixed(1);

        // **नवीन कार्ड्ससाठी गणना**
        const officeDepositTotal = dailyData.reduce((s, r) => s + safeParseFloat(r['ऑफिस मध्ये जमा']), 0);
        const seniorDepositTotal = dailyData.reduce((s, r) => s + safeParseFloat(r['वरीष्ठांकडे जमा']), 0);

        document.getElementById('kpiCards').innerHTML = `
            <div class="kpi-card clickable" onclick="showDetailsPopup('daily', 'एकूण रिकवरी (आजची)')"><div class="icon" style="color:#005A9C; background:#eaf2f8;">💰</div><div class="text"><h3>एकूण रिकवरी (आजची)</h3><p>${formatCurrency(totalRecovery)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('dailyOnline', 'ऑनलाइन रिकवरी (आजची)')"><div class="icon" style="color:var(--online-color); background:#eaf2f8;">📱</div><div class="text"><h3>ऑनलाइन रिकवरी</h3><p>${formatCurrency(onlineRecovery)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('dailyOffline', 'ऑफलाइन रिकवरी (आजची)')"><div class="icon" style="color:var(--secondary-color); background:#e8f8f5;">🏦</div><div class="text"><h3>ऑफलाइन रिकवरी</h3><p>${formatCurrency(offlineRecovery)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('highBalance', 'जास्त शिल्लक कर्मचारी')"><div class="icon" style="color:var(--highlight-color); background:#fdebd0;">⚠️</div><div class="text"><h3>जास्त शिल्लक कर्मचारी</h3><p>${highBalanceCount}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('totalCash', 'एकूण हातावर शिल्लक')"><div class="icon" style="color:#28a745; background:#e8f5e9;">💵</div><div class="text"><h3>एकूण हातावर शिल्लक</h3><p>${formatCurrency(totalCashInHand)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('phonePeQr', 'QR फोनपे ने जमा')">
                <div class="icon" style="color:#8E44AD; background:#f5eef8;">📲</div>
                <div class="text">
                    <h3>QR फोनपे ने जमा</h3>
                    <p>${formatCurrency(phonePeQrTotal)} <span style="font-size: 1.4rem; color: #555;">(${formattedPercentage}%)</span></p>
                </div>
            </div>
            <!-- **नवीन कार्ड: ऑफिस मध्ये जमा** -->
            <div class="kpi-card clickable" onclick="showDetailsPopup('officeDeposit', 'ऑफिस मध्ये जमा')">
                <div class="icon" style="color:#17A2B8; background:#e8f6f8;">🏢</div>
                <div class="text">
                    <h3>ऑफिस मध्ये जमा</h3>
                    <p>${formatCurrency(officeDepositTotal)}</p>
                </div>
            </div>
            <!-- **नवीन कार्ड: वरिष्ठांकडे जमा** -->
            <div class="kpi-card clickable" onclick="showDetailsPopup('seniorDeposit', 'वरीष्ठांकडे जमा')">
                <div class="icon" style="color:#6C757D; background:#f0f1f2;">👨‍💼</div>
                <div class="text">
                    <h3>वरीष्ठांकडे जमा</h3>
                    <p>${formatCurrency(seniorDepositTotal)}</p>
                </div>
            </div>`;
    }

    function showDetailsPopup(dataType, title) {
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        modalTitle.textContent = title;
        
        let data, columns, sortKey;
        const staffNameKey = 'स्टाफचे नांव';

        switch (dataType) {
            case 'daily':
                data = currentFilteredData.daily;
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'एकूण रिकवरी', header: 'एकूण रिकवरी'}];
                sortKey = 'एकूण रिकवरी';
                break;
            case 'dailyOnline':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['ऑनलाइन रिकवरी']) > 0);
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'ऑनलाइन रिकवरी', header: 'ऑनलाइन रिकवरी'}];
                sortKey = 'ऑनलाइन रिकवरी';
                break;
            case 'dailyOffline':
                 data = currentFilteredData.daily.filter(r => safeParseFloat(r['ऑफलाईन रिकवरी']) > 0);
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'ऑफलाईन रिकवरी', header: 'ऑफलाइन रिकवरी'}];
                sortKey = 'ऑफलाईन रिकवरी';
                break;
            case 'highBalance':
                data = currentFilteredData.highBalance;
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'हातावर शिल्लक', header: 'हातावर शिल्लक'}];
                sortKey = 'हातावर शिल्लक';
                break;
            case 'totalCash':
                data = currentFilteredData.totalCash;
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'हातावर शिल्लक', header: 'हातावर शिल्लक'}];
                sortKey = 'हातावर शिल्लक';
                break;
            case 'phonePeQr':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['फोनपे QR']) > 0);
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'फोनपे QR', header: 'फोनपे QR जमा'}];
                sortKey = 'फोनपे QR';
                break;
            // **नवीन कार्ड्ससाठी Popup Logic**
            case 'officeDeposit':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['ऑफिस मध्ये जमा']) > 0);
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'ऑफिस मध्ये जमा', header: 'ऑफिस मध्ये जमा'}];
                sortKey = 'ऑफिस मध्ये जमा';
                break;
            case 'seniorDeposit':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['वरीष्ठांकडे जमा']) > 0);
                columns = [{key: staffNameKey, header: 'स्टाफचे नांव'}, {key: 'वरीष्ठांकडे जमा', header: 'वरीष्ठांकडे जमा'}];
                sortKey = 'वरीष्ठांकडे जमा';
                break;
            default:
                modalBody.innerHTML = '<p>डेटा उपलब्ध नाही.</p>';
                modal.style.display = "block";
                return;
        }

        if (!data || data.length === 0) {
            modalBody.innerHTML = '<p>या विभागासाठी कोणताही डेटा उपलब्ध नाही.</p>';
        } else {
            data.sort((a, b) => safeParseFloat(b[sortKey]) - safeParseFloat(a[sortKey]));
            let tableHTML = '<table><thead><tr>';
            columns.forEach(col => tableHTML += `<th>${col.header}</th>`);
            tableHTML += '</tr></thead><tbody>';

            let totalAmount = 0;
            data.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(col => {
                    const value = row[col.key];
                    if (col.key !== staffNameKey) {
                        tableHTML += `<td>${formatCurrency(value)}</td>`;
                    } else {
                        tableHTML += `<td>${value || '-'}</td>`;
                    }
                });
                tableHTML += '</tr>';
                totalAmount += safeParseFloat(row[sortKey]);
            });
            
            tableHTML += '</tbody>';
            if (columns.length > 1) {
                tableHTML += `<tfoot><tr><td><strong>एकूण</strong></td><td><strong>${formatCurrency(totalAmount)}</strong></td></tr></tfoot>`;
            }
            tableHTML += '</table>';
            modalBody.innerHTML = tableHTML;
        }

        modal.style.display = "block";
    }
    
    function renderHighBalanceTable(unit, highBalanceData) {
        let filteredHighBalance = highBalanceData;
        if (unit !== 'संपूर्ण') { filteredHighBalance = highBalanceData.filter(row => row['युनिट'] === unit); }
        const table = document.getElementById('highBalanceTable');
        let headerHtml = (unit === 'संपूर्ण') ? '<th>स्टाफचे नांव</th><th>युनिट</th><th>हातावर शिल्लक (₹)</th><th>शेवटचा रिपोर्ट</th>' : '<th>स्टाफचे नांव</th><th>हातावर शिल्लक (₹)</th><th>शेवटचा रिपोर्ट दिनांक</th>';
        let bodyHtml = '';
        if (filteredHighBalance.length === 0) {
            const colspan = (unit === 'संपूर्ण') ? 4 : 3;
            bodyHtml = `<tr><td colspan="${colspan}" style="text-align:center;">या युनिटमध्ये कोणीही जास्त शिल्लक असलेला कर्मचारी नाही.</td></tr>`;
        } else {
            filteredHighBalance.sort((a,b) => safeParseFloat(b['हातावर शिल्लक']) - safeParseFloat(a['हातावर शिल्लक'])).forEach(row => {
                bodyHtml += `<tr class="highlight-row"><td>${row['स्टाफचे नांव']}</td>`;
                if (unit === 'संपूर्ण') bodyHtml += `<td>${row['युनिट']}</td>`;
                bodyHtml += `<td>${formatCurrency(row['हातावर शिल्लक'])}</td><td>${new Date(row['दिनांक']).toLocaleDateString('en-GB')}</td></tr>`;
            });
        }
        table.innerHTML = `<thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody>`;
    }

    function renderDetailedReportTable(data) {
        const table = document.getElementById('fullReportTable');
        const displayColumns = [
            { header: 'Staff Name', key: 'स्टाफचे नांव' },
            { header: 'Opening Bal', key: 'प्रारंभीची शिल्लक' },
            { header: 'Online Reco', key: 'ऑनलाइन रिकवरी' },
            { header: 'Offline Reco', key: 'ऑफलाईन रिकवरी' },
            { header: 'Total Reco', key: 'एकूण रिकवरी' },
            { header: 'Total Amt', key: 'एकूण रक्कम' },
            { header: 'SBI', key: 'स्टेट बॅंकेत भरणा' },
            { header: 'MGB', key: 'महा ग्रामीणमध्ये भरणा' },
            { header: 'PhonePe QR', key: 'फोनपे QR' },
            { header: 'Other Bank', key: 'अन्य बॅंक' },
            { header: 'To Sr.', key: 'वरीष्ठांकडे जमा' },
            { header: 'Office Dep', key: 'ऑफिस मध्ये जमा' },
            { header: 'Cash in Hand', key: 'हातावर शिल्लक' },
            { header: 'कृती', key: 'action' }
        ];
        let tableHTML = `<thead><tr>${displayColumns.map(c => `<th>${c.header}</th>`).join('')}</tr></thead><tbody>`;
        data.forEach(row => {
            const isHigh = safeParseFloat(row['हातावर शिल्लक']) > 3000;
            tableHTML += isHigh ? '<tr class="highlight-row">' : '<tr>';
            displayColumns.forEach(col => {
                if (col.key === 'action') {
                    tableHTML += `<td><button class="delete-btn" onclick="deleteReport(event, '${row.Timestamp}')">हटवा</button></td>`;
                } else {
                    const value = row[col.key];
                    tableHTML += `<td>${col.header !== 'Staff Name' ? formatCurrency(value) : (value || '-')}</td>`;
                }
            });
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody><tfoot><tr><td><strong>Total</strong></td>';
        displayColumns.slice(1, -1).forEach(col => {
            const total = data.reduce((sum, row) => sum + safeParseFloat(row[col.key]), 0);
            tableHTML += `<td><strong>${formatCurrency(total)}</strong></td>`;
        });
        tableHTML += '<td></td>'
        tableHTML += '</tr></tfoot>';
        table.innerHTML = tableHTML;
    }

    async function deleteReport(event, timestamp) {
        if (!confirm('तुम्हाला हा रिपोर्ट नक्की हटवायचा आहे का?')) return;
        const button = event.target;
        const originalButtonText = button.textContent;
        button.textContent = 'हटवत आहे...';
        button.disabled = true;
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'deleteReport', timestamp: timestamp })
            });
            if (!response.ok) { throw new Error(`Server responded with status: ${response.status}`); }
            const result = await response.json();
            if (result.success) {
                alert(result.message);
                fullData = fullData.filter(row => row.Timestamp !== timestamp);
                renderDashboard(activeUnit);
            } else { throw new Error(result.message || "Unknown error from server."); }
        } catch (error) {
            alert('रिपोर्ट हटवण्यात अयशस्वी: ' + error.message);
            button.textContent = originalButtonText;
            button.disabled = false;
        }
    }

    function renderManagerialInsights(dailyData, highBalanceStaff) {
        const insightsList = document.createElement('ul');
        const highBalanceInUnit = highBalanceStaff.filter(s => activeUnit === 'संपूर्ण' || s.युनिट === activeUnit);
        if(highBalanceInUnit.length > 0) {
            const highestBalanceStaff = highBalanceInUnit.reduce((max, staff) => safeParseFloat(max['हातावर शिल्लक']) > safeParseFloat(staff['हातावर शिल्लक']) ? max : staff);
            insightsList.innerHTML += `<li>या तारखेपर्यंत, <strong>${highBalanceInUnit.length}</strong> कर्मचाऱ्यांकडे ३००० पेक्षा जास्त शिल्लक आहे. सर्वाधिक शिल्लक <strong>${highestBalanceStaff['स्टाफचे नांव']}</strong> यांच्याकडे (${formatCurrency(highestBalanceStaff['हातावर शिल्लक'])}) आहे.</li>`;
        } else { insightsList.innerHTML += `<li>उत्कृष्ट! या तारखेपर्यंत कोणत्याही कर्मचाऱ्याकडे ३००० पेक्षा जास्त शिल्लक नाही.</li>`; }
        if(dailyData.length > 0) {
            const highestRecoveryStaff = dailyData.reduce((max, staff) => (safeParseFloat(max['एकूण रिकवरी']) || 0) > (safeParseFloat(staff['एकूण रिकवरी']) || 0) ? max : staff, dailyData[0]);
            if (safeParseFloat(highestRecoveryStaff['एकूण रिकवरी']) > 0) { insightsList.innerHTML += `<li>आजच्या दिवशी सर्वाधिक रिकवरी <strong>${highestRecoveryStaff['स्टाफचे नांव']}</strong> यांनी केली आहे (${formatCurrency(highestRecoveryStaff['एकूण रिकवरी'])}).</li>`; }
            else { insightsList.innerHTML += `<li>आजच्या दिवशी कोणत्याही स्टाफने रिकवरी रिपोर्ट केलेली नाही.</li>`; }
        } else { insightsList.innerHTML += `<li>निवडलेल्या तारखेसाठी कोणताही तपशीलवार रिपोर्ट उपलब्ध नाही.</li>`; }
        document.getElementById('managerialInsights').innerHTML = `<h2>व्यवस्थापकांसाठी महत्त्वाची निरीक्षणे</h2>`;
        document.getElementById('managerialInsights').appendChild(insightsList);
    }

    function drawCharts(dailyData, latestDataAsOfDate) {
        const topCashChartDiv = document.getElementById('topCashInHandChart');
        const breakdownChartDiv = document.getElementById('breakdownChart');
        let staffWithCash = latestDataAsOfDate.filter(row => (activeUnit === 'संपूर्ण' || row['युनिट'] === activeUnit) && safeParseFloat(row['हातावर शिल्लक']) > 0);
        if (staffWithCash.length === 0) {
            topCashChartDiv.innerHTML = '<div class="loader">हातावर शिल्लक असलेला डेटा उपलब्ध नाही.</div>';
        } else {
            staffWithCash.sort((a, b) => safeParseFloat(b['हातावर शिल्लक']) - safeParseFloat(a['हातावर शिल्लक']));
            const top5Staff = staffWithCash.slice(0, 5);
            const chartData = [['स्टाफचे नांव', 'हातावर शिल्लक', { role: 'style' }]];
            top5Staff.forEach(staff => { chartData.push([staff['स्टाफचे नांव'], safeParseFloat(staff['हातावर शिल्लक']), '#e74c3c']); });
            const dataTable = google.visualization.arrayToDataTable(chartData);
            const options = { title: `सर्वाधिक शिल्लक असलेले स्टाफ (दि. ${new Date(document.getElementById('dateFilter').value).toLocaleDateString('en-GB')} रोजी)`, legend: { position: 'none' }, hAxis: { title: 'रक्कम (₹)' } };
            new google.visualization.BarChart(topCashChartDiv).draw(dataTable, options);
        }
        const onlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['ऑनलाइन रिकवरी']), 0);
        const offlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['ऑफलाईन रिकवरी']), 0);
        const totalRecovery = onlineRecovery + offlineRecovery;
        if (totalRecovery === 0) {
            breakdownChartDiv.innerHTML = '<div class="loader">आजच्या तारखेला रिकवरीचा डेटा उपलब्ध नाही.</div>';
        } else {
            const breakdownData = google.visualization.arrayToDataTable([['जमा प्रकार', 'रक्कम'], ['ऑनलाइन रिकवरी', onlineRecovery], ['ऑफलाइन रिकवरी', offlineRecovery]]);
            const options = { title: 'ऑनलाइन vs ऑफलाइन रिकवरीचे प्रमाण', pieHole: 0.4, colors: [ '#3498DB', '#1E8449'], pieSliceText: 'percentage', legend: { position: 'bottom' }};
            new google.visualization.PieChart(breakdownChartDiv).draw(breakdownData, options);
        }
    }
</script>
</body>
</html>
