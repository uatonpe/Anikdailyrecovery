
<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #1E8449; /* Green for Offline */
            --online-color: #3498DB; /* Blue for Online */
            --highlight-color: #D35400;
            --danger-color: #C0392B;
            --bg-color: #f4f7fc;
            --card-bg-color: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --border-color: #e0e5ec;
            --shadow: 0 6px 20px rgba(0, 90, 156, 0.1);
            --border-radius: 12px;
        }
        body {
            font-family: 'Noto Sans Devanagari', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 1.5rem;
            color: var(--text-color);
        }
        .container { max-width: 1800px; margin: auto; }
        header { text-align: center; margin-bottom: 1.5rem; }
        header h1 { color: var(--heading-color); font-size: 2.4rem; font-weight: 700; }
        .controls { background: var(--card-bg-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .controls label { font-weight: 600; font-size: 1.1rem; color: var(--heading-color); }
        .controls input[type="date"] { padding: 0.7rem; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        .refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .refresh-btn:hover { background-color: #004a80; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .tab-link { padding: 0.8rem 1.5rem; cursor: pointer; font-weight: 600; font-size: 1.1rem; border: none; background-color: transparent; border-bottom: 4px solid transparent; transition: all 0.3s ease; color: var(--text-color); }
        .tab-link.active { color: var(--primary-color); border-bottom: 4px solid var(--primary-color); background-color: #eaf2f8; border-radius: 8px 8px 0 0; }
        .dashboard-content { display: flex; flex-direction: column; gap: 2rem; }
        .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .kpi-card { display: flex; align-items: center; gap: 1.5rem; background: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card.clickable { cursor: pointer; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 90, 156, 0.15); }
        .kpi-card .icon { font-size: 2.5rem; padding: 1rem; border-radius: 50%; display: grid; place-items: center; }
        .kpi-card .text h3 { margin: 0 0 0.4rem; font-size: 1rem; color: #555; font-weight: 500; }
        .kpi-card .text p { margin: 0; font-size: 2.1rem; font-weight: 700; color: var(--heading-color); }
        .insights-card { background: linear-gradient(135deg, #eaf2f8, #e4ecf7); border: 1px solid #aed6f1; padding: 1.5rem; border-radius: var(--border-radius); }
        .insights-card h2 { margin-top: 0; color: var(--primary-color); }
        .insights-card ul { padding-left: 20px; margin: 0; }
        .insights-card li { margin-bottom: 0.75rem; font-size: 1.1rem; line-height: 1.6; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem; }
        .chart-container, .table-wrapper { background: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .table-wrapper { overflow-x: auto; }
        .table-wrapper h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 0.9rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: linear-gradient(135deg, #f8f9fa, #eef2f7); font-weight: 600; color: var(--primary-color); font-size: 1rem; }
        tbody tr:hover { background-color: #f1f5f9; }
        tfoot tr { background-color: #eaf2f8; font-weight: bold; font-size: 1.1rem; }
        .highlight-row { background-color: #feefea !important; font-weight: 600; color: var(--danger-color); }
        .loader { text-align: center; font-size: 1.2rem; padding: 2rem; color: var(--primary-color); }

        #fullReportTable { font-size: 0.95rem; }
        #fullReportTable th, 
        #fullReportTable td { padding: 0.8rem 0.7rem; }
        
        .delete-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        .delete-btn:hover { background-color: #922b21; }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 700px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.4s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        .modal-body {
             max-height: 60vh;
             overflow-y: auto;
        }
        .modal-body table { font-size: 1rem; }

        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }

    </style>
</head>
<body>
<main class="container">
    <header><h1>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§∏‡§Ç‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1></header>
    <div class="controls">
        <label for="dateFilter">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <input type="date" id="dateFilter">
        <button class="refresh-btn" onclick="loadDashboardData()">‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ</button>
    </div>
    <nav class="tabs" id="unitTabs"></nav>
    <div id="dashboard-content"></div>
</main>

<!-- The Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">‡§§‡§™‡§∂‡•Ä‡§≤</h2>
            <span class="close-button">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamic content will be injected here -->
        </div>
    </div>
</div>

<script>
    const SHEET_ID = "1FJQ7fd__PRnHTDjfvOPWSwGo2_w-S-4sx1mcpRTVskk";
    const API_KEY = "AIzaSyAQQZz2KDKZtJw7YZBRAvHaO-Uy68Ps57s";
    const STAFF_SHEET_NAME = "StaffList";
    const REPORTS_SHEET_NAME = "Recovery Data";
    
    // **‡§Ø‡•á‡§•‡•á ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§µ‡•á‡§¨ ‡•≤‡§™ URL ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ**
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzsiLcDwscTAdmgKszLVjYfKOoj-GLisdLSIX-4kfvweB_JIwkkygVznGN6JEDgHPw/exec";

    google.charts.load('current', {'packages':['corechart']});

    let fullData = [];
    let staffList = [];
    let activeUnit = '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£';
    let currentFilteredData = {
        daily: [],
        highBalance: [],
        totalCash: []
    };
    
    const safeParseFloat = (str) => parseFloat(String(str).replace(/,/g, '')) || 0;

    const formatCurrency = (val) => new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(safeParseFloat(val));

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
        document.getElementById('dateFilter').addEventListener('change', () => renderDashboard(activeUnit));
        
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.querySelector('.close-button');
        closeBtn.onclick = () => modal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };
        
        google.charts.setOnLoadCallback(loadDashboardData);
    });

    async function loadDashboardData() {
        const contentArea = document.getElementById('dashboard-content');
        contentArea.innerHTML = '<div class="loader">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡§æ...</div>';
        try {
            const reportsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/'${REPORTS_SHEET_NAME}'?key=${API_KEY}`;
            const staffUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${STAFF_SHEET_NAME}?key=${API_KEY}`;
            const [reportsResponse, staffResponse] = await Promise.all([fetch(reportsUrl), fetch(staffUrl)]);
            if (!reportsResponse.ok || !staffResponse.ok) throw new Error('API ‡§≤‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶ ‡§Æ‡§ø‡§≥‡§æ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Ä (Key) ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§∂‡•Ä‡§ü ‡§Ü‡§Ø‡§°‡•Ä ‡§§‡§™‡§æ‡§∏‡§æ.');
            const reportsRaw = await reportsResponse.json();
            const staffRaw = await staffResponse.json();
            const headers = reportsRaw.values[0];
            fullData = (reportsRaw.values.slice(1) || []).map(row => {
                let obj = {};
                headers.forEach((header, index) => obj[header.trim()] = row[index] || '');
                return obj;
            });
            staffList = (staffRaw.values.slice(1) || []).map(row => ({unit: row[0], name: row[1]}));
            initializeDashboard();
        } catch (error) {
            contentArea.innerHTML = `<div class="loader" style="color: var(--danger-color);">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§Ü‡§≤‡•Ä: ${error.message}</div>`;
        }
    }

    function initializeDashboard() {
        const units = ['‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£', ...new Set(staffList.map(s => s.unit).filter(Boolean))].sort((a, b) => a === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£' ? -1 : b === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£' ? 1 : a.localeCompare(b, 'mr'));
        const tabsContainer = document.getElementById('unitTabs');
        tabsContainer.innerHTML = '';
        units.forEach(unit => {
            const tab = document.createElement('button');
            tab.className = 'tab-link';
            tab.textContent = unit;
            if (unit === activeUnit) tab.classList.add('active');
            tab.onclick = () => {
                document.querySelector('.tab-link.active')?.classList.remove('active');
                tab.classList.add('active');
                activeUnit = unit;
                renderDashboard(activeUnit);
            };
            tabsContainer.appendChild(tab);
        });
        renderDashboard(activeUnit);
    }
    
    function calculateLatestEntriesAsOf(targetDate) {
        const latestEntries = {};
        const relevantData = fullData.filter(row => row['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï'] && new Date(row['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï']) <= new Date(targetDate));
        for (const row of relevantData) {
            const staffName = row['‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'];
            if (!staffName) continue;
            if (!latestEntries[staffName] || (new Date(row['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï']).getTime() === new Date(latestEntries[staffName]['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï']).getTime() && new Date(row['Timestamp']).getTime() > new Date(latestEntries[staffName]['Timestamp']).getTime()) || new Date(row['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï']) > new Date(latestEntries[staffName]['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï'])) {
                 latestEntries[staffName] = row;
            }
        }
        return Object.values(latestEntries);
    }

    function renderDashboard(unit) {
        const dateFilter = document.getElementById('dateFilter').value;
        let dailyData = fullData.filter(row => row['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï'] === dateFilter);
        if (unit !== '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') { dailyData = dailyData.filter(row => row['‡§Ø‡•Å‡§®‡§ø‡§ü'] === unit); }
        
        const latestDataAsOfDate = calculateLatestEntriesAsOf(dateFilter);
        const highBalanceStaff = latestDataAsOfDate.filter(row => safeParseFloat(row['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) > 3000);
        const totalCashInHandStaff = latestDataAsOfDate.filter(row => safeParseFloat(row['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) > 0);
        
        currentFilteredData.daily = dailyData;
        currentFilteredData.highBalance = (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') ? highBalanceStaff : highBalanceStaff.filter(s => s.‡§Ø‡•Å‡§®‡§ø‡§ü === unit);
        currentFilteredData.totalCash = (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') ? totalCashInHandStaff : totalCashInHandStaff.filter(s => s.‡§Ø‡•Å‡§®‡§ø‡§ü === unit);

        const contentArea = document.getElementById('dashboard-content');
        contentArea.innerHTML = `
            <div class="kpi-cards" id="kpiCards"></div>
            <div class="dashboard-grid">
                <div class="chart-container"><div id="topCashInHandChart" style="height: 400px; width: 100%;"></div></div>
                <div class="chart-container"><div id="breakdownChart" style="height: 400px; width: 100%;"></div></div>
            </div>
            <div class="table-wrapper"><h2 style="color:var(--primary-color);">‡§Æ‡§π‡§§‡•ç‡§µ‡§æ‡§ö‡•á: ‡•©‡•¶‡•¶‡•¶ ‡§™‡•á‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§∏‡•ç‡§ü‡§æ‡§´</h2><table id="highBalanceTable"></table></div>
            <div class="table-wrapper"><h2>‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§§‡§™‡§∂‡•Ä‡§≤‡§µ‡§æ‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${new Date(dateFilter).toLocaleDateString('en-GB')})</h2><table id="fullReportTable"></table></div>
            <div class="insights-card" id="managerialInsights"></div>`;
        
        renderKpiCards(dailyData, highBalanceStaff, latestDataAsOfDate, unit);
        renderHighBalanceTable(unit, highBalanceStaff);
        renderDetailedReportTable(dailyData);
        drawCharts(dailyData, latestDataAsOfDate);
        renderManagerialInsights(dailyData, highBalanceStaff);
    }

    function renderKpiCards(dailyData, highBalanceStaff, latestData, unit) {
        const onlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']), 0);
        const offlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§ë‡§´‡§≤‡§æ‡§à‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']), 0);
        const totalRecovery = onlineRecovery + offlineRecovery;
        const highBalanceCount = (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£' ? highBalanceStaff : highBalanceStaff.filter(s => s.‡§Ø‡•Å‡§®‡§ø‡§ü === unit)).length;
        
        let totalCashInHand = (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£' ? latestData : latestData.filter(row => row['‡§Ø‡•Å‡§®‡§ø‡§ü'] === unit))
                                .reduce((sum, row) => sum + safeParseFloat(row['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']), 0);

        const phonePeQrTotal = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§´‡•ã‡§®‡§™‡•á QR']), 0);
        const phonePeQrPercentage = totalRecovery > 0 ? (phonePeQrTotal / totalRecovery) * 100 : 0;
        const formattedPercentage = phonePeQrPercentage.toFixed(1);

        // **‡§®‡§µ‡•Ä‡§® ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏‡§∏‡§æ‡§†‡•Ä ‡§ó‡§£‡§®‡§æ**
        const officeDepositTotal = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ']), 0);
        const seniorDepositTotal = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ']), 0);

        document.getElementById('kpiCards').innerHTML = `
            <div class="kpi-card clickable" onclick="showDetailsPopup('daily', '‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä (‡§Ü‡§ú‡§ö‡•Ä)')"><div class="icon" style="color:#005A9C; background:#eaf2f8;">üí∞</div><div class="text"><h3>‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä (‡§Ü‡§ú‡§ö‡•Ä)</h3><p>${formatCurrency(totalRecovery)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('dailyOnline', '‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä (‡§Ü‡§ú‡§ö‡•Ä)')"><div class="icon" style="color:var(--online-color); background:#eaf2f8;">üì±</div><div class="text"><h3>‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä</h3><p>${formatCurrency(onlineRecovery)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('dailyOffline', '‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä (‡§Ü‡§ú‡§ö‡•Ä)')"><div class="icon" style="color:var(--secondary-color); background:#e8f8f5;">üè¶</div><div class="text"><h3>‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä</h3><p>${formatCurrency(offlineRecovery)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('highBalance', '‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä')"><div class="icon" style="color:var(--highlight-color); background:#fdebd0;">‚ö†Ô∏è</div><div class="text"><h3>‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</h3><p>${highBalanceCount}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('totalCash', '‡§è‡§ï‡•Ç‡§£ ‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï')"><div class="icon" style="color:#28a745; background:#e8f5e9;">üíµ</div><div class="text"><h3>‡§è‡§ï‡•Ç‡§£ ‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï</h3><p>${formatCurrency(totalCashInHand)}</p></div></div>
            <div class="kpi-card clickable" onclick="showDetailsPopup('phonePeQr', 'QR ‡§´‡•ã‡§®‡§™‡•á ‡§®‡•á ‡§ú‡§Æ‡§æ')">
                <div class="icon" style="color:#8E44AD; background:#f5eef8;">üì≤</div>
                <div class="text">
                    <h3>QR ‡§´‡•ã‡§®‡§™‡•á ‡§®‡•á ‡§ú‡§Æ‡§æ</h3>
                    <p>${formatCurrency(phonePeQrTotal)} <span style="font-size: 1.4rem; color: #555;">(${formattedPercentage}%)</span></p>
                </div>
            </div>
            <!-- **‡§®‡§µ‡•Ä‡§® ‡§ï‡§æ‡§∞‡•ç‡§°: ‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ** -->
            <div class="kpi-card clickable" onclick="showDetailsPopup('officeDeposit', '‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ')">
                <div class="icon" style="color:#17A2B8; background:#e8f6f8;">üè¢</div>
                <div class="text">
                    <h3>‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ</h3>
                    <p>${formatCurrency(officeDepositTotal)}</p>
                </div>
            </div>
            <!-- **‡§®‡§µ‡•Ä‡§® ‡§ï‡§æ‡§∞‡•ç‡§°: ‡§µ‡§∞‡§ø‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ** -->
            <div class="kpi-card clickable" onclick="showDetailsPopup('seniorDeposit', '‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ')">
                <div class="icon" style="color:#6C757D; background:#f0f1f2;">üë®‚Äçüíº</div>
                <div class="text">
                    <h3>‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ</h3>
                    <p>${formatCurrency(seniorDepositTotal)}</p>
                </div>
            </div>`;
    }

    function showDetailsPopup(dataType, title) {
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        modalTitle.textContent = title;
        
        let data, columns, sortKey;
        const staffNameKey = '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ';

        switch (dataType) {
            case 'daily':
                data = currentFilteredData.daily;
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä', header: '‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä'}];
                sortKey = '‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä';
                break;
            case 'dailyOnline':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']) > 0);
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä', header: '‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä'}];
                sortKey = '‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä';
                break;
            case 'dailyOffline':
                 data = currentFilteredData.daily.filter(r => safeParseFloat(r['‡§ë‡§´‡§≤‡§æ‡§à‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']) > 0);
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§ë‡§´‡§≤‡§æ‡§à‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä', header: '‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä'}];
                sortKey = '‡§ë‡§´‡§≤‡§æ‡§à‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä';
                break;
            case 'highBalance':
                data = currentFilteredData.highBalance;
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï', header: '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï'}];
                sortKey = '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï';
                break;
            case 'totalCash':
                data = currentFilteredData.totalCash;
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï', header: '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï'}];
                sortKey = '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï';
                break;
            case 'phonePeQr':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['‡§´‡•ã‡§®‡§™‡•á QR']) > 0);
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§´‡•ã‡§®‡§™‡•á QR', header: '‡§´‡•ã‡§®‡§™‡•á QR ‡§ú‡§Æ‡§æ'}];
                sortKey = '‡§´‡•ã‡§®‡§™‡•á QR';
                break;
            // **‡§®‡§µ‡•Ä‡§® ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏‡§∏‡§æ‡§†‡•Ä Popup Logic**
            case 'officeDeposit':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ']) > 0);
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ', header: '‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ'}];
                sortKey = '‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ';
                break;
            case 'seniorDeposit':
                data = currentFilteredData.daily.filter(r => safeParseFloat(r['‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ']) > 0);
                columns = [{key: staffNameKey, header: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'}, {key: '‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ', header: '‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ'}];
                sortKey = '‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ';
                break;
            default:
                modalBody.innerHTML = '<p>‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</p>';
                modal.style.display = "block";
                return;
        }

        if (!data || data.length === 0) {
            modalBody.innerHTML = '<p>‡§Ø‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</p>';
        } else {
            data.sort((a, b) => safeParseFloat(b[sortKey]) - safeParseFloat(a[sortKey]));
            let tableHTML = '<table><thead><tr>';
            columns.forEach(col => tableHTML += `<th>${col.header}</th>`);
            tableHTML += '</tr></thead><tbody>';

            let totalAmount = 0;
            data.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(col => {
                    const value = row[col.key];
                    if (col.key !== staffNameKey) {
                        tableHTML += `<td>${formatCurrency(value)}</td>`;
                    } else {
                        tableHTML += `<td>${value || '-'}</td>`;
                    }
                });
                tableHTML += '</tr>';
                totalAmount += safeParseFloat(row[sortKey]);
            });
            
            tableHTML += '</tbody>';
            if (columns.length > 1) {
                tableHTML += `<tfoot><tr><td><strong>‡§è‡§ï‡•Ç‡§£</strong></td><td><strong>${formatCurrency(totalAmount)}</strong></td></tr></tfoot>`;
            }
            tableHTML += '</table>';
            modalBody.innerHTML = tableHTML;
        }

        modal.style.display = "block";
    }
    
    function renderHighBalanceTable(unit, highBalanceData) {
        let filteredHighBalance = highBalanceData;
        if (unit !== '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') { filteredHighBalance = highBalanceData.filter(row => row['‡§Ø‡•Å‡§®‡§ø‡§ü'] === unit); }
        const table = document.getElementById('highBalanceTable');
        let headerHtml = (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') ? '<th>‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ</th><th>‡§Ø‡•Å‡§®‡§ø‡§ü</th><th>‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï (‚Çπ)</th><th>‡§∂‡•á‡§µ‡§ü‡§ö‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</th>' : '<th>‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ</th><th>‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï (‚Çπ)</th><th>‡§∂‡•á‡§µ‡§ü‡§ö‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</th>';
        let bodyHtml = '';
        if (filteredHighBalance.length === 0) {
            const colspan = (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') ? 4 : 3;
            bodyHtml = `<tr><td colspan="${colspan}" style="text-align:center;">‡§Ø‡§æ ‡§Ø‡•Å‡§®‡§ø‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ï‡•ã‡§£‡•Ä‡§π‡•Ä ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§Ö‡§∏‡§≤‡•á‡§≤‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§®‡§æ‡§π‡•Ä.</td></tr>`;
        } else {
            filteredHighBalance.sort((a,b) => safeParseFloat(b['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) - safeParseFloat(a['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï'])).forEach(row => {
                bodyHtml += `<tr class="highlight-row"><td>${row['‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ']}</td>`;
                if (unit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£') bodyHtml += `<td>${row['‡§Ø‡•Å‡§®‡§ø‡§ü']}</td>`;
                bodyHtml += `<td>${formatCurrency(row['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï'])}</td><td>${new Date(row['‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï']).toLocaleDateString('en-GB')}</td></tr>`;
            });
        }
        table.innerHTML = `<thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody>`;
    }

    function renderDetailedReportTable(data) {
        const table = document.getElementById('fullReportTable');
        const displayColumns = [
            { header: 'Staff Name', key: '‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ' },
            { header: 'Opening Bal', key: '‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡•Ä‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï' },
            { header: 'Online Reco', key: '‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä' },
            { header: 'Offline Reco', key: '‡§ë‡§´‡§≤‡§æ‡§à‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä' },
            { header: 'Total Reco', key: '‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä' },
            { header: 'Total Amt', key: '‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ï‡•ç‡§ï‡§Æ' },
            { header: 'SBI', key: '‡§∏‡•ç‡§ü‡•á‡§ü ‡§¨‡•Ö‡§Ç‡§ï‡•á‡§§ ‡§≠‡§∞‡§£‡§æ' },
            { header: 'MGB', key: '‡§Æ‡§π‡§æ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§≠‡§∞‡§£‡§æ' },
            { header: 'PhonePe QR', key: '‡§´‡•ã‡§®‡§™‡•á QR' },
            { header: 'Other Bank', key: '‡§Ö‡§®‡•ç‡§Ø ‡§¨‡•Ö‡§Ç‡§ï' },
            { header: 'To Sr.', key: '‡§µ‡§∞‡•Ä‡§∑‡•ç‡§†‡§æ‡§Ç‡§ï‡§°‡•á ‡§ú‡§Æ‡§æ' },
            { header: 'Office Dep', key: '‡§ë‡§´‡§ø‡§∏ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§Æ‡§æ' },
            { header: 'Cash in Hand', key: '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï' },
            { header: '‡§ï‡•É‡§§‡•Ä', key: 'action' }
        ];
        let tableHTML = `<thead><tr>${displayColumns.map(c => `<th>${c.header}</th>`).join('')}</tr></thead><tbody>`;
        data.forEach(row => {
            const isHigh = safeParseFloat(row['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) > 3000;
            tableHTML += isHigh ? '<tr class="highlight-row">' : '<tr>';
            displayColumns.forEach(col => {
                if (col.key === 'action') {
                    tableHTML += `<td><button class="delete-btn" onclick="deleteReport(event, '${row.Timestamp}')">‡§π‡§ü‡§µ‡§æ</button></td>`;
                } else {
                    const value = row[col.key];
                    tableHTML += `<td>${col.header !== 'Staff Name' ? formatCurrency(value) : (value || '-')}</td>`;
                }
            });
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody><tfoot><tr><td><strong>Total</strong></td>';
        displayColumns.slice(1, -1).forEach(col => {
            const total = data.reduce((sum, row) => sum + safeParseFloat(row[col.key]), 0);
            tableHTML += `<td><strong>${formatCurrency(total)}</strong></td>`;
        });
        tableHTML += '<td></td>'
        tableHTML += '</tr></tfoot>';
        table.innerHTML = tableHTML;
    }

    async function deleteReport(event, timestamp) {
        if (!confirm('‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§π‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§ï‡•ç‡§ï‡•Ä ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡§æ ‡§Ü‡§π‡•á ‡§ï‡§æ?')) return;
        const button = event.target;
        const originalButtonText = button.textContent;
        button.textContent = '‡§π‡§ü‡§µ‡§§ ‡§Ü‡§π‡•á...';
        button.disabled = true;
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'deleteReport', timestamp: timestamp })
            });
            if (!response.ok) { throw new Error(`Server responded with status: ${response.status}`); }
            const result = await response.json();
            if (result.success) {
                alert(result.message);
                fullData = fullData.filter(row => row.Timestamp !== timestamp);
                renderDashboard(activeUnit);
            } else { throw new Error(result.message || "Unknown error from server."); }
        } catch (error) {
            alert('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡§ü‡§µ‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä: ' + error.message);
            button.textContent = originalButtonText;
            button.disabled = false;
        }
    }

    function renderManagerialInsights(dailyData, highBalanceStaff) {
        const insightsList = document.createElement('ul');
        const highBalanceInUnit = highBalanceStaff.filter(s => activeUnit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£' || s.‡§Ø‡•Å‡§®‡§ø‡§ü === activeUnit);
        if(highBalanceInUnit.length > 0) {
            const highestBalanceStaff = highBalanceInUnit.reduce((max, staff) => safeParseFloat(max['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) > safeParseFloat(staff['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) ? max : staff);
            insightsList.innerHTML += `<li>‡§Ø‡§æ ‡§§‡§æ‡§∞‡§ñ‡•á‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§, <strong>${highBalanceInUnit.length}</strong> ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§°‡•á ‡•©‡•¶‡•¶‡•¶ ‡§™‡•á‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§Ü‡§π‡•á. ‡§∏‡§∞‡•ç‡§µ‡§æ‡§ß‡§ø‡§ï ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï <strong>${highestBalanceStaff['‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ']}</strong> ‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ‡§ï‡§°‡•á (${formatCurrency(highestBalanceStaff['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï'])}) ‡§Ü‡§π‡•á.</li>`;
        } else { insightsList.innerHTML += `<li>‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü! ‡§Ø‡§æ ‡§§‡§æ‡§∞‡§ñ‡•á‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§ï‡§°‡•á ‡•©‡•¶‡•¶‡•¶ ‡§™‡•á‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§®‡§æ‡§π‡•Ä.</li>`; }
        if(dailyData.length > 0) {
            const highestRecoveryStaff = dailyData.reduce((max, staff) => (safeParseFloat(max['‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']) || 0) > (safeParseFloat(staff['‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']) || 0) ? max : staff, dailyData[0]);
            if (safeParseFloat(highestRecoveryStaff['‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']) > 0) { insightsList.innerHTML += `<li>‡§Ü‡§ú‡§ö‡•ç‡§Ø‡§æ ‡§¶‡§ø‡§µ‡§∂‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§æ‡§ß‡§ø‡§ï ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä <strong>${highestRecoveryStaff['‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ']}</strong> ‡§Ø‡§æ‡§Ç‡§®‡•Ä ‡§ï‡•á‡§≤‡•Ä ‡§Ü‡§π‡•á (${formatCurrency(highestRecoveryStaff['‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä'])}).</li>`; }
            else { insightsList.innerHTML += `<li>‡§Ü‡§ú‡§ö‡•ç‡§Ø‡§æ ‡§¶‡§ø‡§µ‡§∂‡•Ä ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§∏‡•ç‡§ü‡§æ‡§´‡§®‡•á ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•á‡§≤‡•á‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä.</li>`; }
        } else { insightsList.innerHTML += `<li>‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§§‡§æ‡§∞‡§ñ‡•á‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§§‡§™‡§∂‡•Ä‡§≤‡§µ‡§æ‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</li>`; }
        document.getElementById('managerialInsights').innerHTML = `<h2>‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§Æ‡§π‡§§‡•ç‡§§‡•ç‡§µ‡§æ‡§ö‡•Ä ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£‡•á</h2>`;
        document.getElementById('managerialInsights').appendChild(insightsList);
    }

    function drawCharts(dailyData, latestDataAsOfDate) {
        const topCashChartDiv = document.getElementById('topCashInHandChart');
        const breakdownChartDiv = document.getElementById('breakdownChart');
        let staffWithCash = latestDataAsOfDate.filter(row => (activeUnit === '‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£' || row['‡§Ø‡•Å‡§®‡§ø‡§ü'] === activeUnit) && safeParseFloat(row['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) > 0);
        if (staffWithCash.length === 0) {
            topCashChartDiv.innerHTML = '<div class="loader">‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§Ö‡§∏‡§≤‡•á‡§≤‡§æ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</div>';
        } else {
            staffWithCash.sort((a, b) => safeParseFloat(b['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']) - safeParseFloat(a['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']));
            const top5Staff = staffWithCash.slice(0, 5);
            const chartData = [['‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ', '‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï', { role: 'style' }]];
            top5Staff.forEach(staff => { chartData.push([staff['‡§∏‡•ç‡§ü‡§æ‡§´‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ'], safeParseFloat(staff['‡§π‡§æ‡§§‡§æ‡§µ‡§∞ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï']), '#e74c3c']); });
            const dataTable = google.visualization.arrayToDataTable(chartData);
            const options = { title: `‡§∏‡§∞‡•ç‡§µ‡§æ‡§ß‡§ø‡§ï ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§∏‡•ç‡§ü‡§æ‡§´ (‡§¶‡§ø. ${new Date(document.getElementById('dateFilter').value).toLocaleDateString('en-GB')} ‡§∞‡•ã‡§ú‡•Ä)`, legend: { position: 'none' }, hAxis: { title: '‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)' } };
            new google.visualization.BarChart(topCashChartDiv).draw(dataTable, options);
        }
        const onlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']), 0);
        const offlineRecovery = dailyData.reduce((s, r) => s + safeParseFloat(r['‡§ë‡§´‡§≤‡§æ‡§à‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä']), 0);
        const totalRecovery = onlineRecovery + offlineRecovery;
        if (totalRecovery === 0) {
            breakdownChartDiv.innerHTML = '<div class="loader">‡§Ü‡§ú‡§ö‡•ç‡§Ø‡§æ ‡§§‡§æ‡§∞‡§ñ‡•á‡§≤‡§æ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</div>';
        } else {
            const breakdownData = google.visualization.arrayToDataTable([['‡§ú‡§Æ‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞', '‡§∞‡§ï‡•ç‡§ï‡§Æ'], ['‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä', onlineRecovery], ['‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä', offlineRecovery]]);
            const options = { title: '‡§ë‡§®‡§≤‡§æ‡§á‡§® vs ‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä‡§ö‡•á ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£', pieHole: 0.4, colors: [ '#3498DB', '#1E8449'], pieSliceText: 'percentage', legend: { position: 'bottom' }};
            new google.visualization.PieChart(breakdownChartDiv).draw(breakdownData, options);
        }
    }
</script>
</body>
</html>
